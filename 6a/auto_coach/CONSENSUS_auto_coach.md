# CONSENSUS_auto_coach

## 明确的需求描述和验收标准

### 核心功能需求
1. **实时图像识别**：识别炉石战棋游戏画面中的所有关键信息
2. **数据结构化**：将识别结果转换为结构化JSON数据
3. **WebSocket服务**：实时推送识别数据给客户端
4. **MCP集成**：提供MCP接口供Cursor调用
5. **Overlay界面**：显示识别状态和建议

### 验收标准
- 识别准确率 > 90%
- 识别延迟 < 200ms
- WebSocket连接稳定，支持多客户端
- MCP接口响应时间 < 100ms
- 系统资源占用 < 500MB内存

## 技术实现方案和技术约束

### 技术栈选择
- **图像识别**：OpenCV + 模板匹配 + PaddleOCR（数字识别）
- **Web服务**：FastAPI + WebSocket
- **数据结构**：基于现有JSON格式扩展
- **MCP集成**：本地HTTP调用WebSocket服务

### 系统架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   游戏画面      │    │   识别引擎      │    │   数据服务      │
│                │───▶│                │───▶│                │
│   实时截屏      │    │   模板匹配      │    │   结构化输出    │
└─────────────────┘    │   OCR识别       │    │   WebSocket     │
                       │   特征提取      │    │   MCP接口       │
                       └─────────────────┘    └─────────────────┘
```

### 识别模块设计
1. **版面分割**：基于固定ROI的游戏界面分割
2. **模板匹配**：使用现有图片资源进行随从/英雄识别
3. **OCR识别**：识别数字（金币、等级、攻击力、生命值）
4. **状态检测**：冻结状态、刷新按钮等UI状态

### 数据结构设计
```json
{
  "timestamp": "2024-01-01T12:00:00Z",
  "game_state": {
    "tavern_tier": 6,
    "gold": 10,
    "turn": 8,
    "hero": {
      "id": "hero_1",
      "name": "Reno Jackson",
      "health": 25,
      "armor": 9
    }
  },
  "shop": {
    "frozen": false,
    "minions": [
      {
        "position": 0,
        "id": "minion_123",
        "name": "Kalecgos",
        "attack": 2,
        "health": 6,
        "tier": 6,
        "tribe": "dragon",
        "golden": false
      }
    ]
  },
  "board": {
    "minions": [
      {
        "position": 0,
        "id": "minion_456",
        "name": "Bronze Warden",
        "attack": 8,
        "health": 56,
        "golden": true,
        "divine_shield": true,
        "reborn": true
      }
    ]
  }
}
```

## 技术约束和集成方案

### 性能约束
- 识别频率：100ms/帧
- 内存使用：< 500MB
- CPU使用：< 30%

### 集成方案
1. **MCP调用流程**：
   - Cursor通过MCP工具调用本地HTTP接口
   - HTTP接口转发到WebSocket服务
   - 获取最新识别数据并返回

2. **数据同步策略**：
   - 实时推送：游戏状态变化时立即推送
   - 定时推送：每100ms推送一次完整状态
   - 按需获取：客户端可请求特定时间点的数据

## 任务边界限制和验收标准

### 任务边界
- 不进行自动游戏操作
- 不修改游戏文件
- 不进行网络通信（除WebSocket服务）

### 验收标准
1. **功能完整性**：所有识别功能正常工作
2. **性能达标**：延迟和准确率满足要求
3. **稳定性**：长时间运行无崩溃
4. **易用性**：MCP接口调用简单

## 确认所有不确定性已解决

### 已确认的技术方案
- 使用OpenCV进行图像识别
- 使用FastAPI提供WebSocket服务
- 使用本地HTTP接口进行MCP集成
- 基于现有图片资源进行模板匹配

### 待验证的技术点
- 模板匹配的准确率
- OCR识别的稳定性
- WebSocket的性能表现
- MCP集成的兼容性
